<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>BREAKOUT</title>
        <style type="text/css">
            canvas {
                border: 1px dashed #000000;
            }
        </style>
    </head>
    <body onload="init()">
        <center>
            <canvas id="canvas" width="600" height="480">
                Navegador não compatível com HTML5 canvas, por favor não use IE
            </canvas>
        </center>
        <script type="text/javascript">

            // TODO:
            // movimentação da bola
            // colisões com blocos
            // remover bloco quando colidir -> setar posição na matriz para null
            // pontuação
            // gráficos
            // o que mais for necessário

            // Variáveis globais
            var canvas, context; // Objetos do HTML5 Canvas
            var jogador; // dados do jogador
            var bola; // dados da bola
            var tecla; // tecla sendo pressionada no momento (esquerda/direita)
            var blocos; // matriz bidimensional para guardar os blocos
            var numLinhas, numColunas; //número de linhas e colunas dos blocos

            function init(){
                // Canvas e context
                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");

                // Jogador (JS object)
                jogador = {
                    w: 90, //largura
                    h: 20, //altura
                    x: 0,
                    y: 0,
                    velocidade: 20
                };
                jogador.x = canvas.width / 2 - jogador.w / 2;
                jogador.y = canvas.height - jogador.h;

                // Bola (JS Object)
                bola = {
                    raio: 10, 
                    x: canvas.width / 2, 
                    y: canvas.height / 2,
                    baixo: false,
                    angulo: 5,
                    velocidade: 10
                };
                bola.x = canvas.width / 2;
                bola.y = jogador.y - bola.raio;

                // Blocos
                // 5 linhas, 10 blocos por linha
                // largura: 60, altura: 20
                numLinhas = 5;
                numColunas = 10;
                blocos = new Array(numLinhas);
                for(var linha = 0; linha < numLinhas; linha++){
                    blocos[linha] = new Array(numColunas);
                    for(var coluna = 0; coluna < numColunas; coluna++){
                        blocos[linha][coluna] = {
                            x: 60 * coluna, // X varia junto com a coluna
                            y: 20 * linha, // Y varia junto com a linha
                            w: 60, //largura
                            h: 20  //altura
                        }
                    }
                }

                // Teclas pressionadas
                tecla = {
                    direita: false,
                    esquerda: false
                }

                // Eventos
                document.addEventListener('keyup', keyUp, false);
                document.addEventListener('keydown', keyDown, false);

                // Intervalo do Gameloop: 30 fps
                setInterval(gameLoop, 1000 / 30);
            }

            // Códigos de teclas:
            // Esquerda: 37
            // Direita: 39
            function keyDown(e){
                if(e.keyCode == 37){
                    tecla.esquerda = true;
                }
                else if(e.keyCode == 39){ 
                    tecla.direita = true;
                }
            }

            function keyUp(e){
                if(e.keyCode == 37){
                    tecla.esquerda = false;
                }
                else if(e.keyCode == 39){
                    tecla.direita = false;
                }
            }

            function gameLoop(){
                // Processar entrada do jogador e atualizar estado do jogo
                atualizarEstadoJogo();
                // Atualizar tela do jogo
                atualizarTela();
            }

            function atualizarEstadoJogo(){
                // Movimentação jogador
                if(tecla.direita != tecla.esquerda){
                    if(tecla.esquerda){
                        if(jogador.x > 0){
                            jogador.x -= jogador.velocidade;
                        }
                    }
                    else {
                        if(jogador.x < canvas.width - jogador.w){
                            jogador.x += jogador.velocidade;
                        }
                    }
                }
            }

            function desenharBloco(linha, coluna){
                // desenhar apenas blocos que não sejam null
                // (ou seja, não colidiram com a bola)
                // cada linha terá uma cor, como o Breakout de Atari
                bloco = blocos[linha][coluna];
                if(bloco != null) {
                    // devemos adicionar um contorno?
                    //context.strokeRect(bloco.x, bloco.y, bloco.w, bloco.h); //contorno
                    if(linha == 0) context.fillStyle = "green";
                    else if(linha == 1) context.fillStyle = "blue";
                    else if(linha == 2) context.fillStyle = "red";
                    else if(linha == 3) context.fillStyle = "yellow";
                    else if(linha == 4) context.fillStyle = "orange";
                    context.fillRect(bloco.x, bloco.y, bloco.w, bloco.h); //preenchimento
                }
            }

            function atualizarTela(){
                // Limpeza da tela
                context.clearRect(0, 0, canvas.width, canvas.height);

                // Jogador
                context.fillStyle = "black";
                context.fillRect(jogador.x, jogador.y, jogador.w, jogador.h);

                // Bola
                context.fillStyle = "red";
                context.beginPath();
                context.arc(bola.x, bola.y, bola.raio, 0, Math.PI*2, true);
                context.closePath();
                context.fill();

                // Blocos - desenhados linha por linha
                for(var linha = 0; linha < numLinhas; linha++){
                    for(var coluna = 0; coluna < numColunas; coluna++){
                        desenharBloco(linha, coluna);
                    }
                }
            }           
        </script>
    </body>
</html>
